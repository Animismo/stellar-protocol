## Preamble

```
SEP: 0008
Title: Regulated Assets
Author: Interstellar.com, Howard Chen <@howardtw>
Status: Active
Created: 2018-08-22
Updated: 2020-10-20
Version 2.0.0
```

## Simple Summary

Regulated Assets provide ecosystem support for assets that require an issuer’s approval (or a delegated third party’s approval, such as a licensed securities exchange) on a per-transaction basis. It standardizes the identification of such assets as well as defines the protocol for performing compliance checks and requesting issuer approval.

**Target Audience**: Asset issuers, issuance platforms, wallet developers, and exchanges

## Motivation

Stellar aims to be an ideal platform for issuing securities. As such, it must provide tools to comply with various regulatory requirements. Regulation often requires asset issuers to monitor and approve every transaction involving the issued asset and to enforce an assortment of constraints. This SEP provides support for these requirements.

## Overview

Implementing a Regulated Asset consists of these parts:
- [Stellar.toml]: Issuers will advertise the existence of an Approval Service and the approval criteria via their stellar.toml file.
- [Approval Server]: HTTP protocol for transaction signing.
- [Transaction Composition]: Wallets will have to put operations that fully authorize the accounts for the asset, transact the asset, and deauthorize the accounts in a single transaction.

## Regulated Assets Approval Flow

1. User creates and signs a transaction.
2. Wallet resolves asset information and detects that it's a regulated asset.
3. Wallet sends the transaction to the approval server.
4. Approval server determines whether the transaction is compliant based on the compliance ruleset and look up the current state of the ledger if necessary.
5. Wallet handles approval response:
    1. *Success?* Transaction has been approved and signed by issuer.
    2. *Rejected?* Wallet should display given error message to the user.

## Stellar.toml

Issuers will advertise the existence of an Approval Service through their stellar.toml file. This is done in the [[CURRENCIES]] section as different assets can have different requirements.

### Fields:

- `regulated` is a boolean indicating whether or not this is a regulated asset. If missing, `false` is assumed.
- `approval_server` is the url of an approval service that signs validated transactions.
- `approval_criteria` is a human readable string that explains the issuer's requirements for approving transactions.

### Example

```toml
[[CURRENCIES]]
code="GOAT"
issuer="GD5T6IPRNCKFOHQWT264YPKOZAWUMMZOLZBJ6BNQMUGPWGRLBK3U7ZNP"
regulated=true
approval_server="https://goat.io/tx_approve"
approval_criteria="The goat approval server will ensure that transactions are compliant with NFO regulation"
```

## Approval Server

The transaction approval server receives a signed transaction and checks for compliance and signs it on success.

### Possible results
- Success: Transaction was found compliant and signed by service.
- Rejected: Transaction was rejected.

### Request

Transaction approval requests are executed by submitting an `HTTP POST` to `approval_server` with `Content-Type=application/x-www-form-urlencoded` and a single `tx` parameter. `tx` value is a base64 encoded Transaction Envelope XDR signed by the user. This is the transaction that will be tested for compliance and signed on success.

### Responses

HTTP responses have an `application/json` encoded body. All responses will contain, at least, a top level `status` parameter that indicates the type of the result.

#### Success Response

A Successful response will have a `200` HTTP status code and `success` as the `status` value. This response means that the transaction was found compliant and signed.

Parameters:

Name | Data Type | Description
-----|-----------|------------
status|string|`"success"`
tx|string|Transaction Envelope XDR, base64 encoded. This transaction will have the original signature(s) from the request as well as the asset issuer's signature.
message|string|A human readable string containing information to pass on to the user (optional).

#### Rejected Response

A Rejected response will have a `400` HTTP status code and `rejected` as the `status` value. It means that the transaction is not compliant and thus not signed by the server. The client should act accordingly based on the error message or retry if the issuer needs more time to validate the transaction.

Parameters:

Name | Data Type | Description
-----|-----------|------------
status|string|`"rejected"`
error|string|A human readable string explaining why the transaction is not compliant.

## Transaction Composition

WIP.

## Discussion

### Should my asset be a regulated asset?

Ideally, no. Implementing Regulated Assets should only be used when absolutely necessary, such as for regulatory reasons. It comes with a substantial operational overhead, added complexity, and burden for users. Issuers should only go down this route if it is absolutely required.

### Why doesn’t the approval server submit transactions to the network?

- Separation of concerns between signing transactions and submitting them.
- Transactions might require more signatures from further regulated asset issuers.
- Wallets can handle the failure from transaction submission differently based on the type of errors.

### Should the ruleset simply sit in the approval server?

- Issuers can configure the rules with server configs.
- The server can read the ruleset from a file and we can format the file so that it has a section about ledger state under Horizon.

### Should the approval server make an API call to the issuer's server for rule checking if any?

- We should define the request and the response format in this case.

### How should the rule server obtain the KYC information in order to make a decision?


[Stellar.toml]: #stellartoml
[Approval Server]: #approval-server
[Transaction Composition]: #transaction-composition
